name: Manual Release to Maven Central

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0, 2.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git describe

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"
          echo "Version: $VERSION"
          echo "Tag: $TAG"
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "ERROR: Version must match semantic versioning (X.Y.Z or X.Y.Z-suffix)"
            exit 1
          fi

          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "ERROR: Tag $TAG already exists"
            exit 1
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Create tag locally for version detection
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Manual release $VERSION"

      - name: Verify version matches tag
        run: |
          GRADLE_VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "Gradle version: $GRADLE_VERSION"
          echo "Expected version: $VERSION"
          if [ "$GRADLE_VERSION" != "$VERSION" ]; then
            echo "ERROR: Gradle version ($GRADLE_VERSION) does not match tag version ($VERSION)"
            exit 1
          fi

      - name: Build and test
        run: ./gradlew clean build test

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import
          # Test signing capability
          echo "test" | gpg --clearsign --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" > /dev/null
          echo "GPG key imported and tested successfully"

      - name: Configure GPG for signing
        run: |
          # Configure gpg for non-interactive signing
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye

      - name: Publish to Maven Central
        env:
          CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
          CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          # Export GPG_TTY for passphrase
          export GPG_TTY=$(tty)

          # Create gradle.properties with GPG credentials
          cat > ~/.gradle/gradle.properties << EOF
          signing.gnupg.keyName=$GPG_KEY_ID
          signing.gnupg.passphrase=$GPG_PASSPHRASE
          EOF

          chmod 600 ~/.gradle/gradle.properties

          # Publish to Maven Central via Central Portal
          ./gradlew publishAggregationToCentralPortal \
            --no-daemon \
            --stacktrace

      - name: Build distribution archives
        run: |
          ./gradlew :database-utils:jar :database-utils:javadocJar :database-utils:sourcesJar
          ./gradlew :pretender:jar :pretender:javadocJar :pretender:sourcesJar

      - name: Push tag to remote
        run: |
          git push origin "$TAG"
          echo "Pushed tag: $TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.VERSION }}
          body: |
            ## PretenderDB ${{ env.VERSION }}

            ### Maven Central

            ```xml
            <dependency>
              <groupId>io.github.pretenderdb</groupId>
              <artifactId>pretender</artifactId>
              <version>${{ env.VERSION }}</version>
            </dependency>
            ```

            ```gradle
            implementation("io.github.pretenderdb:pretender:${{ env.VERSION }}")
            ```

            ### Modules Published
            - `io.github.pretenderdb:database-utils:${{ env.VERSION }}`
            - `io.github.pretenderdb:pretender:${{ env.VERSION }}`

            ### What's Changed
            See commits since last release for details.

            **Note:** Artifacts may take up to 2 hours to appear in Maven Central after release.
          files: |
            database-utils/build/libs/*.jar
            pretender/build/libs/*.jar
          draft: false
          prerelease: ${{ contains(env.VERSION, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Release failed! Check logs for details."
