name: Auto Release on Main

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  auto-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to find tags and check changed files

      - name: Check if only docs/workflows changed
        id: changes
        run: |
          # Get list of changed files in the push
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger, proceeding with release"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For push events, check what files changed
          # Compare with previous commit
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Filter out docs and workflow changes
          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -v -E '\.md$|^docs/|^\.github/' || true)

          if [ -z "$CODE_CHANGES" ]; then
            echo "Only documentation or workflow files changed, skipping release"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Code changes detected, proceeding with release"
            echo "Code changes:"
            echo "$CODE_CHANGES"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        if: steps.changes.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if current commit already has a release tag
        id: check
        if: steps.changes.outputs.skip == 'false'
        run: |
          # Check if HEAD already has a version tag
          EXISTING_TAG=$(git tag --points-at HEAD | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" || true)
          if [ -n "$EXISTING_TAG" ]; then
            echo "Current commit already has release tag: $EXISTING_TAG"
            echo "Skipping auto-release to prevent duplicate."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "No release tag on current commit, proceeding with auto-release."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Get latest tag and increment patch version
        id: version
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        run: |
          # Get the latest semantic version tag
          LATEST_TAG=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" | sort -V | tail -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No existing version tags found, starting with v1.0.0"
            NEW_VERSION="1.0.0"
          else
            echo "Latest tag: $LATEST_TAG"

            # Remove 'v' prefix and split into components
            VERSION=${LATEST_TAG#v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)

            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          fi

          NEW_TAG="v$NEW_VERSION"
          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "TAG=$NEW_TAG" >> $GITHUB_ENV

      - name: Set up JDK 21
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        uses: gradle/actions/setup-gradle@v3

      - name: Build and test
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        run: ./gradlew clean build test

      - name: Import GPG key
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import
          # Test signing capability
          echo "test" | gpg --clearsign --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" > /dev/null
          echo "GPG key imported and tested successfully"

      - name: Configure GPG for signing
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        run: |
          # Configure gpg for non-interactive signing
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye

      - name: Publish to Maven Central
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        env:
          CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
          CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          # Export GPG_TTY for passphrase
          export GPG_TTY=$(tty)

          # Create gradle.properties with GPG credentials
          cat > ~/.gradle/gradle.properties << EOF
          signing.gnupg.keyName=$GPG_KEY_ID
          signing.gnupg.passphrase=$GPG_PASSPHRASE
          EOF

          chmod 600 ~/.gradle/gradle.properties

          # Publish to Maven Central via Central Portal
          ./gradlew publishAggregationToCentralPortal \
            --no-daemon \
            --stacktrace

      - name: Build distribution archives
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        run: |
          ./gradlew :database-utils:jar :database-utils:javadocJar :database-utils:sourcesJar
          ./gradlew :pretender:jar :pretender:javadocJar :pretender:sourcesJar

      - name: Create and push tag
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        run: |
          # Create annotated tag after successful build and publish
          git tag -a "$TAG" -m "Auto-release $VERSION"
          git push origin "$TAG"
          echo "Created and pushed tag: $TAG"

      - name: Create GitHub Release
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.VERSION }}
          body: |
            ## PretenderDB ${{ env.VERSION }}

            ### Maven Central

            ```xml
            <dependency>
              <groupId>io.github.pretenderdb</groupId>
              <artifactId>pretender</artifactId>
              <version>${{ env.VERSION }}</version>
            </dependency>
            ```

            ```gradle
            implementation("io.github.pretenderdb:pretender:${{ env.VERSION }}")
            ```

            ### Modules Published
            - `io.github.pretenderdb:database-utils:${{ env.VERSION }}`
            - `io.github.pretenderdb:pretender:${{ env.VERSION }}`

            ### What's Changed
            See commits since last release for details.

            **Note:** Artifacts may take up to 2 hours to appear in Maven Central after release.
          files: |
            database-utils/build/libs/*.jar
            pretender/build/libs/*.jar
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        run: |
          echo "## Auto-Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Built and tested the project" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Published to Maven Central" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Created tag: \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Created GitHub release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Maven Central" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`gradle" >> $GITHUB_STEP_SUMMARY
          echo "implementation(\"io.github.pretenderdb:pretender:$VERSION\")" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Skipped Summary - Docs Only
        if: steps.changes.outputs.skip == 'true'
        run: |
          echo "## Auto-Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Only documentation or workflow files changed. No release needed." >> $GITHUB_STEP_SUMMARY

      - name: Skipped Summary - Duplicate Tag
        if: steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'true'
        run: |
          echo "## Auto-Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Current commit already has a release tag. No action taken." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure() && steps.changes.outputs.skip == 'false' && steps.check.outputs.skip == 'false'
        run: |
          echo "::error::Auto-release failed! Check logs for details."
