name: Publish Snapshot

on:
  # Disabled: auto-release.yml now handles releases on main
  # This workflow can be manually triggered if needed for development snapshots
  workflow_dispatch:

jobs:
  snapshot:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Verify SNAPSHOT version
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "Version: $VERSION"
          if [[ ! "$VERSION" == *-SNAPSHOT ]]; then
            echo "ERROR: Expected SNAPSHOT version but got: $VERSION"
            echo "This workflow only publishes snapshots. For releases, use a version tag."
            exit 1
          fi
          echo "SNAPSHOT_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build and test
        run: ./gradlew clean build test

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import
          echo "test" | gpg --clearsign --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" > /dev/null
          echo "GPG key imported successfully"

      - name: Configure GPG for signing
        run: |
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye

      - name: Publish Snapshot to Central Portal
        env:
          CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
          CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          export GPG_TTY=$(tty)

          cat > ~/.gradle/gradle.properties << EOF
          signing.gnupg.keyName=$GPG_KEY_ID
          signing.gnupg.passphrase=$GPG_PASSPHRASE
          EOF

          chmod 600 ~/.gradle/gradle.properties

          ./gradlew publishAggregationToCentralSnapshots \
            --no-daemon \
            --stacktrace

      - name: Summary
        run: |
          echo "## Snapshot Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: \`$SNAPSHOT_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modules" >> $GITHUB_STEP_SUMMARY
          echo "- \`io.github.pretenderdb:database-utils:$SNAPSHOT_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`io.github.pretenderdb:pretender:$SNAPSHOT_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository" >> $GITHUB_STEP_SUMMARY
          echo "Add the snapshot repository to use these artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`kotlin" >> $GITHUB_STEP_SUMMARY
          echo "repositories {" >> $GITHUB_STEP_SUMMARY
          echo "    maven(\"https://central.sonatype.com/repository/maven-snapshots/\")" >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
